#!/bin/bash
# Claude PM Framework - Health Check
# Generated by deployment script v4.0.0

echo "ğŸ” Claude PM Framework Health Check"
echo "Enhanced with AI-trackdown-tools validation"
echo "=========================================="

cd "/Users/masa/Projects/claude-multiagent-pm"

# Check framework core
if [ -d "claude_pm" ]; then
    echo "âœ“ Framework core present"
else
    echo "âŒ Framework core missing"
    exit 1
fi

# Check CLI wrappers
if [ -x "bin/aitrackdown" ]; then
    echo "âœ“ aitrackdown CLI available"
else
    echo "âŒ aitrackdown CLI missing"
    exit 1
fi

# Check configuration
if [ -f ".claude-pm/config.json" ]; then
    echo "âœ“ Deployment configuration present"
else
    echo "âŒ Deployment configuration missing"
    exit 1
fi

# Test AI-trackdown functionality
echo "Validating AI-trackdown-tools integration..."

# Test basic CLI
if ./aitrackdown --version >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown CLI executable"
else
    echo "âŒ AI-trackdown CLI version check failed"
    exit 1
fi

# Test status command
if ./aitrackdown status >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown status command working"
else
    echo "âš  AI-trackdown status command issue"
fi

# Test backlog command
if ./aitrackdown backlog >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown backlog command working"
else
    echo "âš  AI-trackdown backlog command issue"
fi

# Test epic list command
if ./aitrackdown epic list >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown epic management working"
else
    echo "âš  AI-trackdown epic management issue"
fi

# Test issue list command
if ./aitrackdown issue list >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown issue management working"
else
    echo "âš  AI-trackdown issue management issue"
fi

# Test task list command
if ./aitrackdown task list >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown task management working"
else
    echo "âš  AI-trackdown task management issue"
fi

# Check task structure
if [ -d "tasks" ]; then
    echo "âœ“ AI-trackdown task structure present"
    
    # Count items in each category
    EPIC_COUNT=$(find tasks/epics -name "*.md" 2>/dev/null | wc -l)
    ISSUE_COUNT=$(find tasks/issues -name "*.md" 2>/dev/null | wc -l)
    TASK_COUNT=$(find tasks/tasks -name "*.md" 2>/dev/null | wc -l)
    
    echo "  - Epics: $EPIC_COUNT"
    echo "  - Issues: $ISSUE_COUNT"
    echo "  - Tasks: $TASK_COUNT"
    
    TOTAL_ITEMS=$((EPIC_COUNT + ISSUE_COUNT + TASK_COUNT))
    if [ $TOTAL_ITEMS -gt 0 ]; then
        echo "âœ“ AI-trackdown has $TOTAL_ITEMS tracked items"
    else
        echo "âš  AI-trackdown has no tracked items"
    fi
else
    echo "âŒ AI-trackdown task structure missing"
    exit 1
fi

# Check Python environment
if python3 --version >/dev/null 2>&1; then
    echo "âœ“ Python environment ready"
else
    echo "âŒ Python environment issue"
    exit 1
fi

# Test the comprehensive health system
echo "Testing comprehensive health system..."

if python3 -c "import claude_pm.cli; print('âœ“ Claude PM CLI module accessible')" 2>/dev/null; then
    echo "âœ“ Claude PM CLI module accessible"
else
    echo "âš  Claude PM CLI module issue"
fi

# Test the health command
if python3 -m claude_pm.cli health --help >/dev/null 2>&1; then
    echo "âœ“ Health command available"
else
    echo "âš  Health command issue"
fi

# Test AI-trackdown health monitor
if python3 "$SCRIPT_DIR/ai_trackdown_health_monitor.py" --help >/dev/null 2>&1; then
    echo "âœ“ AI-trackdown health monitor available"
else
    echo "âš  AI-trackdown health monitor issue"
fi

echo "======================================"
echo "ğŸ‰ Health check completed successfully"
echo "ğŸ“Š Run 'python3 -m claude_pm.cli health' for detailed framework health"
echo "ğŸ” Run 'python3 scripts/ai_trackdown_health_monitor.py' for AI-trackdown health check"
